name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: copilot-runner-set
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yaml clusters/ infrastructure/ apps/ monitoring/ || echo "YAML linting completed with warnings"

      - name: Install MCP clients globally
        run: |
          npm config set fund false
          npm install -g kubernetes-mcp-server@latest

      - name: Install flux-operator-mcp
        run: |
          if [ ! -f ".devcontainer/features/flux-operator-mcp/install.sh" ]; then
            echo "Error: flux-operator-mcp install script not found"
            exit 1
          fi
          sudo bash .devcontainer/features/flux-operator-mcp/install.sh

      - name: Set GITHUB_HOST for CodeQL
        # Required for Copilot coding agent environment to resolve GitHub API endpoints
        # See: https://github.com/orgs/community/discussions/177903#discussioncomment-14841783
        run: |
          echo "GITHUB_HOST=github.com" >> $GITHUB_ENV

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl for in-cluster access
        run: |
          # The runner is inside the cluster with mounted service account
          mkdir -p $HOME/.kube
          
          KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          
          kubectl config set-cluster kyrion \
            --server=https://kubernetes.default.svc \
            --certificate-authority=$KUBE_CA \
            --embed-certs=true
          
          kubectl config set-credentials copilot-agent-readonly \
            --token=$KUBE_TOKEN
          
          kubectl config set-context copilot-agent \
            --cluster=kyrion \
            --user=copilot-agent-readonly \
            --namespace=default
          
          kubectl config use-context copilot-agent

      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Install kubeseal
        run: |
          cd /tmp
          curl -LO https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
          tar xfz kubeseal-0.24.0-linux-amd64.tar.gz
          sudo install -m 755 kubeseal /usr/local/bin/kubeseal
          rm -f kubeseal kubeseal-0.24.0-linux-amd64.tar.gz
