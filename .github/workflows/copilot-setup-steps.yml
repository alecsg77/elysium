name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yaml clusters/ infrastructure/ apps/ monitoring/ || echo "YAML linting completed"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl for cluster access (read-only)
        if: ${{ secrets.KUBE_TOKEN != '' }}
        run: |
          echo "Configuring kubectl with read-only cluster access..."
          
          # Create kubeconfig directory
          mkdir -p $HOME/.kube
          
          # Configure cluster
          kubectl config set-cluster kyrion \
            --server="${{ secrets.KUBE_SERVER || 'https://kubernetes.default.svc' }}" \
            --certificate-authority=<(echo "${{ secrets.KUBE_CA_CERT }}" | base64 -d) \
            --embed-certs=true
          
          # Configure credentials
          kubectl config set-credentials copilot-agent-readonly \
            --token="${{ secrets.KUBE_TOKEN }}"
          
          # Configure context
          kubectl config set-context copilot-agent \
            --cluster=kyrion \
            --user=copilot-agent-readonly \
            --namespace=default
          
          # Use the context
          kubectl config use-context copilot-agent
          
          echo "✓ kubectl configured with read-only cluster access"

      - name: Verify cluster access
        if: ${{ secrets.KUBE_TOKEN != '' }}
        run: |
          echo "Testing cluster connectivity..."
          
          # Test basic connectivity
          if kubectl cluster-info &>/dev/null; then
            echo "✓ Cluster connection successful"
            
            # Test read permissions
            echo "Testing read permissions..."
            kubectl get namespaces &>/dev/null && echo "✓ Can list namespaces"
            kubectl get pods -A --limit=5 &>/dev/null && echo "✓ Can list pods"
            kubectl get deployments -A --limit=5 &>/dev/null && echo "✓ Can list deployments"
            
            # Test Flux resources
            if kubectl get hr -A --limit=5 &>/dev/null; then
              echo "✓ Can list Flux HelmReleases"
            fi
            
            if kubectl get kustomizations -A --limit=5 &>/dev/null; then
              echo "✓ Can list Flux Kustomizations"
            fi
            
            # Verify no write access (should fail)
            if ! kubectl auth can-i create pods -A &>/dev/null; then
              echo "✓ Verified: No write access (as expected)"
            else
              echo "⚠ Warning: Write access detected (unexpected)"
            fi
            
            echo ""
            echo "Cluster access configured successfully!"
            echo "You can now use kubectl commands to investigate cluster resources."
          else
            echo "⚠ Cluster connection not available (secrets not configured)"
            echo "To enable cluster access, configure these repository secrets:"
            echo "  - KUBE_TOKEN: Service account token"
            echo "  - KUBE_CA_CERT: Cluster CA certificate (base64 encoded)"
            echo "  - KUBE_SERVER: Cluster API server URL"
          fi

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Validate Flux installation
        run: |
          flux --version

      - name: Build Kustomize overlays
        run: |
          echo "Building apps Kustomization..."
          kustomize build apps/kyrion/ > /dev/null || echo "Apps build completed with warnings"

          echo "Building infrastructure Kustomization..."
          kustomize build infrastructure/controllers/ > /dev/null || echo "Infrastructure build completed with warnings"
          kustomize build infrastructure/configs/ > /dev/null || echo "Infrastructure configs build completed with warnings"

      - name: Validate Flux Kustomizations (dry-run)
        run: |
          echo "Validating Flux Kustomizations..."
          flux build kustomization apps --path clusters/kyrion --dry-run || echo "Flux validation completed"

      - name: Install kubeseal
        run: |
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
          tar xfz kubeseal-0.24.0-linux-amd64.tar.gz
          sudo install -m 755 kubeseal /usr/local/bin/kubeseal

      - name: Validate sealed secrets public key
        run: |
          if [ -f "etc/certs/pub-sealed-secrets.pem" ]; then
            echo "✓ Sealed secrets public key found"
            openssl x509 -in etc/certs/pub-sealed-secrets.pem -noout -text || echo "Public key validation completed"
          else
            echo "⚠ Sealed secrets public key not found (expected for new clusters)"
          fi

      - name: Check for shell scripts
        run: |
          if [ -f "scripts/bootstrap_flux.sh" ]; then
            echo "✓ Bootstrap script found"
            bash -n scripts/bootstrap_flux.sh || echo "Script syntax check completed"
          fi

      - name: Summary
        run: |
          echo "✓ YAML linting completed"
          echo "✓ Kustomize builds validated"
          echo "✓ Flux CLI validated"
          echo "✓ Tools installed: kubectl, kustomize, flux, kubeseal"
          if [ -n "${{ secrets.KUBE_TOKEN }}" ]; then
            echo "✓ Cluster access configured (read-only)"
          fi
          echo ""
          echo "Environment ready for GitOps operations!"
