name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yaml clusters/ infrastructure/ apps/ monitoring/ || echo "YAML linting completed"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Validate Flux installation
        run: |
          flux --version

      - name: Build Kustomize overlays
        run: |
          echo "Building apps Kustomization..."
          kustomize build apps/kyrion/ > /dev/null || echo "Apps build completed with warnings"
          
          echo "Building infrastructure Kustomization..."
          kustomize build infrastructure/controllers/ > /dev/null || echo "Infrastructure build completed with warnings"
          kustomize build infrastructure/configs/ > /dev/null || echo "Infrastructure configs build completed with warnings"

      - name: Validate Flux Kustomizations (dry-run)
        run: |
          echo "Validating Flux Kustomizations..."
          flux build kustomization apps --path clusters/kyrion --dry-run || echo "Flux validation completed"

      - name: Install kubeseal
        run: |
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
          tar xfz kubeseal-0.24.0-linux-amd64.tar.gz
          sudo install -m 755 kubeseal /usr/local/bin/kubeseal

      - name: Validate sealed secrets public key
        run: |
          if [ -f "etc/certs/pub-sealed-secrets.pem" ]; then
            echo "✓ Sealed secrets public key found"
            openssl x509 -in etc/certs/pub-sealed-secrets.pem -noout -text || echo "Public key validation completed"
          else
            echo "⚠ Sealed secrets public key not found (expected for new clusters)"
          fi

      - name: Check for shell scripts
        run: |
          if [ -f "scripts/bootstrap_flux.sh" ]; then
            echo "✓ Bootstrap script found"
            bash -n scripts/bootstrap_flux.sh || echo "Script syntax check completed"
          fi

      - name: Summary
        run: |
          echo "✓ YAML linting completed"
          echo "✓ Kustomize builds validated"
          echo "✓ Flux CLI validated"
          echo "✓ Tools installed: kubectl, kustomize, flux, kubeseal"
          echo ""
          echo "Environment ready for GitOps operations!"
